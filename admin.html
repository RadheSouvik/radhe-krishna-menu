.<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; background: #f3f4f6; }
        
        .custom-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 50px; z-index: 10000; opacity: 0; transition: 0.3s; pointer-events: none; }
        .custom-toast.show { opacity: 1; top: 30px; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .login-wrap { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
            z-index: 5000; display: flex; justify-content: center; align-items: center; 
        }
        .login-card { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            padding: 40px 30px; border-radius: 20px; width: 320px; text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            animation: floatUp 0.5s ease-out;
        }
        @keyframes floatUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
        
        .login-title { color: white; font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .login-sub { color: #94a3b8; font-size: 0.9rem; margin-bottom: 25px; }
        .pin-input { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); 
            color: white; font-size: 1.5rem; letter-spacing: 8px; text-align: center; 
            padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; 
            margin-bottom: 20px; transition: 0.3s;
        }
        .pin-input:focus { border-color: #3b82f6; outline: none; background: rgba(255,255,255,0.1); }
        .login-btn { 
            background: #3b82f6; color: white; border: none; padding: 15px; width: 100%; 
            border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; 
            transition: 0.3s; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4); }

        .top-nav { background: #1e293b; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .burger { font-size: 1.5rem; cursor: pointer; }
        .sidebar { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: #1e293b; padding-top: 60px; transition: 0.3s; z-index: 999; box-shadow: 2px 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .sidebar.active { left: 0; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:900; display:none; }
        .overlay.active { display:block; }

        .nav-btn { color: #94a3b8; padding: 15px 20px; display: flex; align-items: center; gap: 10px; text-decoration: none; font-weight: 500; border-left: 4px solid transparent; cursor: pointer; }
        .nav-btn.active, .nav-btn:hover { background: #334155; color: white; border-left: 4px solid #3b82f6; }
        
        .main { padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        .page { display: none; animation: fadeIn 0.3s; } .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0}to{opacity:1} }
        
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        .btn { padding: 12px; width: 100%; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-icon { padding: 8px 12px; border: none; border-radius: 6px; color: white; cursor: pointer; margin-left: 5px; font-size: 0.9rem; }
        .bg-blue { background: #3b82f6; } .bg-green { background: #10b981; } .bg-red { background: #ef4444; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }

        .modal-wrap { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; position: relative; }
    </style>
</head>
<body>

    <div id="login-screen" class="login-wrap">
        <div class="login-card">
            <div class="login-title">Admin Access</div>
            <div class="login-sub">Please enter your security PIN</div>
            <input type="password" id="input-pin" class="pin-input" maxlength="4" placeholder="••••">
            <button class="login-btn" onclick="checkLogin()">Unlock Dashboard</button>
        </div>
    </div>

    <div id="toast" class="custom-toast">Success</div>
    <div class="loader-overlay" id="loader"><div class="spinner"></div><p style="margin-top:10px; font-weight:600;">Updating...</p></div>

    <div class="top-nav">
        <div class="burger" onclick="toggleMenu()"><i class="fas fa-bars"></i></div>
        <div style="font-weight:700; font-size:1.2rem;">Admin Panel</div>
        <div style="width:24px;"></div>
    </div>

    <div class="overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <div>
            <div class="nav-btn active" onclick="nav('dash')"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-btn" onclick="nav('cats')"><i class="fas fa-list"></i> Categories</div>
            <div class="nav-btn" onclick="nav('items')"><i class="fas fa-hamburger"></i> Menu Items</div>
            <div class="nav-btn" onclick="nav('design')"><i class="fas fa-paint-brush"></i> Banners & Speed</div>
            <div class="nav-btn" onclick="nav('loc')"><i class="fas fa-map-marker-alt"></i> Location Map</div>
        </div>
        <div style="margin-top: auto;">
            <div class="nav-btn" onclick="openPinModal()"><i class="fas fa-key"></i> Change PIN</div>
            <div class="nav-btn" onclick="location.reload()" style="color:#ef4444;"><i class="fas fa-sign-out-alt"></i> Logout</div>
        </div>
    </div>

    <div class="main">
        <div id="dash" class="page active">
            <h2>Dashboard</h2>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <span>Restaurant Status</span>
                <label class="switch"><input type="checkbox" id="shop-open"><span class="slider"></span></label>
            </div>
            <div class="card">
                <h3>Contact Numbers</h3>
                <label>Order WhatsApp:</label><input type="number" id="wa-ord" placeholder="Ex: 9876543210">
                <label>Call Button:</label><input type="number" id="wa-call" placeholder="Ex: 9876543210">
            </div>
            <div class="card">
                <h3>Marquee Text</h3>
                <input type="text" id="marquee-txt" placeholder="Scrolling text...">
                <button class="btn bg-blue" onclick="saveSettings()">Save Changes</button>
            </div>
        </div>

        <div id="cats" class="page">
            <h2>Categories</h2>
            <div class="card">
                <input type="text" id="cat-name" placeholder="New Category Name">
                <button class="btn bg-blue" onclick="addCat()">Add Category</button>
            </div>
            <div id="cat-list"></div>
        </div>

        <div id="items" class="page">
            <h2>Menu Items</h2>
            <div class="card" style="border-top:4px solid #10b981;">
                <h3>Add Item</h3>
                <input type="text" id="i-name" placeholder="Name">
                <input type="number" id="i-price" placeholder="Price">
                <select id="i-cat"></select>
                <input type="text" id="i-img" placeholder="Image URL">
                <input type="text" id="i-desc" placeholder="Description">
                <button class="btn bg-green" onclick="addItem()">Add Item</button>
            </div>
            <div id="item-list"></div>
        </div>

        <div id="design" class="page">
            <h2>Banners</h2>
            <div class="card">
                <label>Slider Speed (Seconds):</label><input type="number" id="ban-speed">
                <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                <input type="text" id="b1" placeholder="Banner 1 URL">
                <input type="text" id="b2" placeholder="Banner 2 URL">
                <input type="text" id="b3" placeholder="Banner 3 URL">
                <button class="btn bg-blue" onclick="saveBanners()">Update Banners</button>
            </div>
        </div>

        <div id="loc" class="page">
            <h2>Location Settings</h2>
            <div class="card">
                <label>Google Map Embed URL (src):</label>
                <input type="text" id="map-embed" placeholder="https://www.google.com/maps/embed?pb=...">
                <label style="margin-top:15px; display:block;">Direction Link:</label>
                <input type="text" id="map-link" placeholder="https://maps.app.goo.gl/...">
                <button class="btn bg-blue" onclick="saveLocation()">Save Location</button>
            </div>
        </div>
    </div>

    <!-- PIN Change Modal (New Logic) -->
    <div class="modal-wrap" id="modal-pin">
        <div class="modal-box">
            <h3>Change Security PIN</h3>
            
            <label>Current PIN:</label>
            <input type="password" id="old-pin" placeholder="Enter Old PIN" maxlength="4" style="text-align:center; letter-spacing:3px;">
            
            <label>New PIN:</label>
            <input type="password" id="new-pin" placeholder="Enter New PIN" maxlength="4" style="text-align:center; letter-spacing:3px;">
            
            <label>Confirm New PIN:</label>
            <input type="password" id="confirm-pin" placeholder="Re-enter New PIN" maxlength="4" style="text-align:center; letter-spacing:3px;">
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn bg-blue" onclick="changePinLogic()">Update PIN</button>
                <button class="btn bg-red" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Category Edit Modal -->
    <div class="modal-wrap" id="modal-cat">
        <div class="modal-box">
            <h3>Edit Category</h3>
            <input type="hidden" id="edit-cat-id">
            <input type="text" id="edit-cat-name" placeholder="Category Name">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn bg-blue" onclick="saveCatEdit()">Save</button>
                <button class="btn bg-red" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Item Edit Modal -->
    <div class="modal-wrap" id="modal-item">
        <div class="modal-box">
            <h3>Edit Item</h3>
            <input type="hidden" id="edit-item-id">
            <label>Name:</label><input type="text" id="edit-item-name">
            <label>Price:</label><input type="number" id="edit-item-price">
            <label>Category:</label><select id="edit-item-cat"></select>
            <label>Image URL:</label><input type="text" id="edit-item-img">
            <label>Description:</label><input type="text" id="edit-item-desc">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn bg-blue" onclick="saveItemEdit()">Update</button>
                <button class="btn bg-red" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyDifkwUmP5MehfgXdhFTs6DQzX-pNR2snE", authDomain: "radhe-krishna-1bc79.firebaseapp.com", databaseURL: "https://radhe-krishna-1bc79-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "radhe-krishna-1bc79", storageBucket: "radhe-krishna-1bc79.firebasestorage.app", messagingSenderId: "755534416421", appId: "1:755534416421:web:6b97cac0c954d223094dcc" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let cats={}, menu={}, currentPin="1234";
        const loader = document.getElementById('loader');
        
        window.checkLogin = () => {
            const input = document.getElementById('input-pin').value;
            if(input === currentPin) {
                document.getElementById('login-screen').style.display = 'none';
                showToast("Welcome Admin");
            } else {
                showToast("Wrong PIN!");
            }
        }

        window.toggleMenu = () => { 
            document.getElementById('sidebar').classList.toggle('active'); 
            document.querySelector('.overlay').classList.toggle('active');
            document.body.style.overflow = document.body.style.overflow === 'hidden' ? '' : 'hidden';
        }
        window.nav = (id) => { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); event.currentTarget.classList.add('active'); toggleMenu(); }
        function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
        function showLoad(){loader.style.display='flex';} function hideLoad(){loader.style.display='none';}
        window.closeModals = () => { 
            document.getElementById('modal-cat').style.display='none'; 
            document.getElementById('modal-item').style.display='none'; 
            document.getElementById('modal-pin').style.display='none';
        }

        onValue(ref(db, 'config'), snap => {
            const c = snap.val() || {};
            currentPin = c.adminPin || "1234";
            document.getElementById('shop-open').checked = c.restaurantOpen;
            let wa = c.whatsappOrderNumber || ""; if(wa.startsWith("91")) wa = wa.substring(2); document.getElementById('wa-ord').value = wa;
            let call = c.contactCallNumber || ""; if(call.startsWith("91")) call = call.substring(2); document.getElementById('wa-call').value = call;
            document.getElementById('marquee-txt').value = c.marqueeText || '';
            document.getElementById('ban-speed').value = c.bannerSpeed || 3;
            document.getElementById('map-embed').value = c.mapEmbed || '';
            document.getElementById('map-link').value = c.mapLink || '';
            if(c.banners){ document.getElementById('b1').value=c.banners[0]||''; document.getElementById('b2').value=c.banners[1]||''; document.getElementById('b3').value=c.banners[2]||''; }
        });
        
        onValue(ref(db, 'categories'), snap => { cats = snap.val() || {}; renderCats(); });
        onValue(ref(db, 'menu'), snap => { menu = snap.val() || {}; renderMenu(); });

        window.openPinModal = () => {
            toggleMenu(); 
            // Clear inputs
            document.getElementById('old-pin').value = '';
            document.getElementById('new-pin').value = '';
            document.getElementById('confirm-pin').value = '';
            document.getElementById('modal-pin').style.display = 'flex';
        }

        // New PIN Change Logic
        window.changePinLogic = () => {
            const oldP = document.getElementById('old-pin').value;
            const newP = document.getElementById('new-pin').value;
            const confP = document.getElementById('confirm-pin').value;

            if (oldP !== currentPin) {
                showToast("Old PIN is incorrect!");
                return;
            }
            if (newP.length < 4) {
                showToast("PIN must be 4 digits");
                return;
            }
            if (newP !== confP) {
                showToast("New PINs do not match!");
                return;
            }

            showLoad();
            update(ref(db, 'config'), { adminPin: newP }).then(() => { 
                hideLoad();
                closeModals(); 
                showToast("PIN Changed Successfully!"); 
            });
        }

        window.saveSettings = () => {
            let w=document.getElementById('wa-ord').value; w=w?"91"+w:"";
            let c=document.getElementById('wa-call').value; c=c?"91"+c:"";
            update(ref(db, 'config'), { restaurantOpen: document.getElementById('shop-open').checked, whatsappOrderNumber: w, contactCallNumber: c, marqueeText: document.getElementById('marquee-txt').value }).then(() => showToast("Saved!"));
        }
        window.saveBanners = () => { update(ref(db, 'config'), { bannerSpeed: parseInt(document.getElementById('ban-speed').value), banners: [document.getElementById('b1').value, document.getElementById('b2').value, document.getElementById('b3').value] }).then(() => showToast("Banners Saved!")); }
        window.saveLocation = () => { update(ref(db, 'config'), { mapEmbed: document.getElementById('map-embed').value, mapLink: document.getElementById('map-link').value }).then(() => showToast("Location Saved!")); }

        window.addCat = () => { const n=document.getElementById('cat-name').value; if(n) push(ref(db, 'categories'), {name:n}).then(()=>{document.getElementById('cat-name').value=''; showToast("Category Added");}); }
        window.delCat = (id) => { for(let k in menu) if(menu[k].category===id){showToast("Cat not empty!"); return;} if(confirm("Delete?")) remove(ref(db, `categories/${id}`)); }
        
        window.openCatEdit = (id, name) => {
            document.getElementById('edit-cat-id').value = id;
            document.getElementById('edit-cat-name').value = name;
            document.getElementById('modal-cat').style.display = 'flex';
        }
        window.saveCatEdit = () => {
            const id = document.getElementById('edit-cat-id').value;
            const name = document.getElementById('edit-cat-name').value;
            if(name) update(ref(db, `categories/${id}`), { name: name }).then(() => { closeModals(); showToast("Category Updated"); });
        }

        function renderCats() {
            const l=document.getElementById('cat-list'), s=document.getElementById('i-cat'), es=document.getElementById('edit-item-cat');
            l.innerHTML=''; s.innerHTML=''; es.innerHTML='';
            for(let k in cats) { 
                l.innerHTML+=`
                <div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                    <b>${cats[k].name}</b> 
                    <div>
                        <button class="btn-icon bg-blue" onclick="openCatEdit('${k}', '${cats[k].name}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon bg-red" onclick="delCat('${k}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
                let opt = `<option value="${k}">${cats[k].name}</option>`;
                s.innerHTML+=opt; es.innerHTML+=opt;
            }
        }

        window.addItem = () => {
            const n=document.getElementById('i-name').value; if(!n)return; showLoad();
            push(ref(db, 'menu'), { name:n, price:parseInt(document.getElementById('i-price').value), category:document.getElementById('i-cat').value, image:document.getElementById('i-img').value, description:document.getElementById('i-desc').value, isAvailable:true }).then(()=>{ showToast("Item Added"); hideLoad(); document.getElementById('i-name').value=''; });
        }
        
        window.toggleItem = (id, st) => update(ref(db, `menu/${id}`), { isAvailable: st });
        window.delItem = (id) => { if(confirm("Delete?")) remove(ref(db, `menu/${id}`)); }
        
        window.openItemEdit = (id) => {
            const i = menu[id];
            document.getElementById('edit-item-id').value = id;
            document.getElementById('edit-item-name').value = i.name;
            document.getElementById('edit-item-price').value = i.price;
            document.getElementById('edit-item-cat').value = i.category;
            document.getElementById('edit-item-img').value = i.image || '';
            document.getElementById('edit-item-desc').value = i.description || '';
            document.getElementById('modal-item').style.display = 'flex';
        }

        window.saveItemEdit = () => {
            const id = document.getElementById('edit-item-id').value;
            showLoad();
            update(ref(db, `menu/${id}`), {
                name: document.getElementById('edit-item-name').value,
                price: parseInt(document.getElementById('edit-item-price').value),
                category: document.getElementById('edit-item-cat').value,
                image: document.getElementById('edit-item-img').value,
                description: document.getElementById('edit-item-desc').value
            }).then(() => { hideLoad(); closeModals(); showToast("Item Updated"); });
        }

        function renderMenu() {
            const l=document.getElementById('item-list'); l.innerHTML='';
            for(let id in menu) { 
                let i=menu[id], c=i.isAvailable!==false?'checked':''; 
                l.innerHTML+=`
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${i.name}</b> (${i.price})<br><small>${cats[i.category]?.name||''}</small></div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <label class="switch"><input type="checkbox" ${c} onchange="toggleItem('${id}',this.checked)"><span class="slider"></span></label>
                        <button class="btn-icon bg-blue" onclick="openItemEdit('${id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon bg-red" onclick="delItem('${id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`; 
            }
        }
    </script>
</body>
</html>